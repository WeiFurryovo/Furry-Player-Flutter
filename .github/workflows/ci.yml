name: CI (Artifacts)

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  android-debug:
    name: Android Debug APK (artifact)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK (sdkmanager)
        run: |
          set -euxo pipefail
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          export ANDROID_SDK_ROOT="${ANDROID_HOME}"
          sdkmanager --version
          # Ensure cmdline-tools present on runner
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --install "cmdline-tools;latest"
          # `yes | sdkmanager --licenses` may end with `yes: Broken pipe` under pipefail; only enforce sdkmanager's exit code.
          set +o pipefail
          yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --licenses >/dev/null
          status="${PIPESTATUS[1]}"
          set -o pipefail
          test "$status" -eq 0
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --install "ndk;26.1.10909125"
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --list | sed -n '1,120p'

      - name: Build debug APK (no signing secrets needed)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/26.1.10909125
        run: |
          set -euxo pipefail
          mkdir -p dist/android/flutter
          (
            ./apps/furry_flutter/create_flutter_app.sh --no-ffi
            cd apps/furry_flutter/furry_flutter_app
            flutter analyze
            flutter build apk --debug --verbose
          ) 2>&1 | tee dist/android/flutter/android_debug_build.log
          cp -f apps/furry_flutter/furry_flutter_app/build/app/outputs/flutter-apk/app-debug.apk dist/android/flutter/

      - name: Checksums
        if: success()
        run: |
          set -euxo pipefail
          cd dist/android/flutter
          sha256sum app-debug.apk > SHA256SUMS.txt

      - name: Upload artifact (android-debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-debug
          path: |
            dist/android/flutter/app-debug.apk
            dist/android/flutter/android_debug_build.log
            dist/android/flutter/SHA256SUMS.txt

  linux-desktop:
    name: Linux Desktop (artifact)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux deps for Flutter desktop
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libblkid-dev liblzma-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Linux desktop bundle
        run: |
          set -euxo pipefail
          mkdir -p dist/desktop/flutter/linux
          (
            ./apps/furry_flutter/create_flutter_app.sh --no-android
            cargo --version
            rustc --version
            cargo build --release -p furry_ffi -v
            cd apps/furry_flutter/furry_flutter_app
            flutter config --enable-linux-desktop
            flutter analyze
            flutter build linux --release --verbose
            cp -f ../../../target/release/libfurry_ffi.so build/linux/x64/release/bundle/
            test -f build/linux/x64/release/bundle/libfurry_ffi.so
            tar -C build/linux/x64/release -czf ../../../dist/desktop/flutter/linux/furry_flutter_linux.tar.gz bundle
          ) 2>&1 | tee dist/desktop/flutter/linux/linux_desktop_build.log

      - name: Checksums
        if: success()
        run: |
          set -euxo pipefail
          cd dist/desktop/flutter/linux
          sha256sum furry_flutter_linux.tar.gz > SHA256SUMS.txt

      - name: Upload artifact (linux-desktop)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-desktop
          path: |
            dist/desktop/flutter/linux/furry_flutter_linux.tar.gz
            dist/desktop/flutter/linux/linux_desktop_build.log
            dist/desktop/flutter/linux/SHA256SUMS.txt

  windows-desktop:
    name: Windows Desktop (artifact)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        shell: pwsh
        run: |
          flutter doctor -v

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create Flutter app (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $root = (Get-Location).Path
          $outDir = Join-Path $root "apps\furry_flutter\furry_flutter_app"
          $templates = Join-Path $root "apps\furry_flutter\templates"

          if (!(Test-Path $outDir)) {
            New-Item -ItemType Directory -Force -Path (Split-Path $outDir) | Out-Null
            Push-Location (Split-Path $outDir)
            flutter create --org com.furry --project-name furry_flutter_app --android-language kotlin furry_flutter_app
            Pop-Location
          }

          Push-Location $outDir
          flutter pub add file_picker path_provider just_audio path ffi
          Pop-Location

          Copy-Item -Recurse -Force (Join-Path $templates "lib\*") (Join-Path $outDir "lib")
          Copy-Item -Recurse -Force (Join-Path $templates "android\*") (Join-Path $outDir "android")

      - name: Build Windows desktop bundle
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $env:RUST_BACKTRACE = "1"
          $root = (Get-Location).Path
          New-Item -ItemType Directory -Force -Path dist\desktop\flutter\windows | Out-Null
          $log = "dist\\desktop\\flutter\\windows\\windows_desktop_build.log"

          & {
            cargo --version
            rustc --version
            cargo build --release -p furry_ffi -v
            cd apps/furry_flutter/furry_flutter_app
            flutter config --enable-windows-desktop
            flutter analyze
            flutter build windows --release --verbose

            New-Item -ItemType Directory -Force -Path ..\..\..\dist\desktop\flutter\windows | Out-Null
            $dllSrc = Join-Path $root "target\\release\\furry_ffi.dll"
            if (!(Test-Path $dllSrc)) { throw "Missing furry_ffi.dll at: $dllSrc" }
            Copy-Item -Force $dllSrc build\windows\x64\runner\Release\
            if (!(Test-Path "build\\windows\\x64\\runner\\Release\\furry_ffi.dll")) { throw "Failed to copy furry_ffi.dll into Release folder" }
            Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath ..\..\..\dist\desktop\flutter\windows\furry_flutter_windows.zip -Force
            if (!(Test-Path "..\\..\\..\\dist\\desktop\\flutter\\windows\\furry_flutter_windows.zip")) { throw "Failed to create zip bundle" }
          } 2>&1 | Tee-Object -FilePath $log

          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Checksums
        if: success()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd dist\desktop\flutter\windows
          $hash = (Get-FileHash furry_flutter_windows.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  furry_flutter_windows.zip" | Out-File -Encoding ascii SHA256SUMS.txt

      - name: Upload artifact (windows-desktop)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-desktop
          path: |
            dist/desktop/flutter/windows/furry_flutter_windows.zip
            dist/desktop/flutter/windows/windows_desktop_build.log
            dist/desktop/flutter/windows/SHA256SUMS.txt
