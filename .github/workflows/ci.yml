name: CI (Artifacts)

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  android-debug:
    name: Android Debug APK (artifact)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: "26.1.10909125"

      - name: Build debug APK (no signing secrets needed)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          set -euxo pipefail
          ./apps/furry_flutter/create_flutter_app.sh --no-ffi
          cd apps/furry_flutter/furry_flutter_app
          flutter build apk --debug

          mkdir -p ../../../../dist/android/flutter
          cp -f build/app/outputs/flutter-apk/app-debug.apk ../../../../dist/android/flutter/

      - name: Checksums
        run: |
          set -euxo pipefail
          cd dist/android/flutter
          sha256sum app-debug.apk > SHA256SUMS.txt

      - name: Upload artifact (android-debug)
        uses: actions/upload-artifact@v4
        with:
          name: android-debug
          path: |
            dist/android/flutter/app-debug.apk
            dist/android/flutter/SHA256SUMS.txt

  linux-desktop:
    name: Linux Desktop (artifact)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux deps for Flutter desktop
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libblkid-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Linux desktop bundle
        run: |
          set -euxo pipefail
          ./apps/furry_flutter/create_flutter_app.sh --no-android
          cargo build --release -p furry_ffi
          cd apps/furry_flutter/furry_flutter_app
          flutter config --enable-linux-desktop
          flutter build linux --release
          cp -f ../../../../target/release/libfurry_ffi.so build/linux/x64/release/bundle/ || true

          mkdir -p ../../../../dist/desktop/flutter/linux
          tar -C build/linux/x64/release -czf ../../../../dist/desktop/flutter/linux/furry_flutter_linux.tar.gz bundle

      - name: Checksums
        run: |
          set -euxo pipefail
          cd dist/desktop/flutter/linux
          sha256sum furry_flutter_linux.tar.gz > SHA256SUMS.txt

      - name: Upload artifact (linux-desktop)
        uses: actions/upload-artifact@v4
        with:
          name: linux-desktop
          path: |
            dist/desktop/flutter/linux/furry_flutter_linux.tar.gz
            dist/desktop/flutter/linux/SHA256SUMS.txt

  windows-desktop:
    name: Windows Desktop (artifact)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Create Flutter app (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $root = (Get-Location).Path
          $outDir = Join-Path $root "apps\furry_flutter\furry_flutter_app"
          $templates = Join-Path $root "apps\furry_flutter\templates"

          if (!(Test-Path $outDir)) {
            New-Item -ItemType Directory -Force -Path (Split-Path $outDir) | Out-Null
            Push-Location (Split-Path $outDir)
            flutter create --org com.furry --project-name furry_flutter_app --android-language kotlin furry_flutter_app
            Pop-Location
          }

          Push-Location $outDir
          flutter pub add file_picker path_provider just_audio path ffi
          Pop-Location

          Copy-Item -Recurse -Force (Join-Path $templates "lib\*") (Join-Path $outDir "lib")
          Copy-Item -Recurse -Force (Join-Path $templates "android\*") (Join-Path $outDir "android")

      - name: Build Windows desktop bundle
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cargo build --release -p furry_ffi
          cd apps/furry_flutter/furry_flutter_app
          flutter config --enable-windows-desktop
          flutter build windows --release

          New-Item -ItemType Directory -Force -Path ..\..\..\..\dist\desktop\flutter\windows | Out-Null
          Copy-Item -Force ..\..\..\..\target\release\furry_ffi.dll build\windows\x64\runner\Release\ -ErrorAction SilentlyContinue
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath ..\..\..\..\dist\desktop\flutter\windows\furry_flutter_windows.zip -Force

      - name: Checksums
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd dist\desktop\flutter\windows
          $hash = (Get-FileHash furry_flutter_windows.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  furry_flutter_windows.zip" | Out-File -Encoding ascii SHA256SUMS.txt

      - name: Upload artifact (windows-desktop)
        uses: actions/upload-artifact@v4
        with:
          name: windows-desktop
          path: |
            dist/desktop/flutter/windows/furry_flutter_windows.zip
            dist/desktop/flutter/windows/SHA256SUMS.txt

