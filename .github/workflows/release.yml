name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  android:
    name: Android (APK/AAB)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK (sdkmanager)
        run: |
          set -euxo pipefail
          mkdir -p ~/.android
          touch ~/.android/repositories.cfg
          export ANDROID_SDK_ROOT="${ANDROID_HOME}"
          sdkmanager --version
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --install "cmdline-tools;latest"
          # `yes | sdkmanager --licenses` may end with `yes: Broken pipe` under pipefail; only enforce sdkmanager's exit code.
          set +o pipefail
          yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --licenses >/dev/null
          status="${PIPESTATUS[1]}"
          set -o pipefail
          test "$status" -eq 0
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --install "ndk;26.1.10909125"
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --list | sed -n '1,120p'

      - name: Build Flutter Android (signed)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/26.1.10909125
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euxo pipefail
          ./apps/furry_flutter/create_flutter_app.sh --no-ffi
          cd apps/furry_flutter/furry_flutter_app

          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "[ERROR] Missing secrets for signing. See docs/github_actions.md" >&2
            exit 2
          fi

          mkdir -p android/app
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF

          flutter analyze
          flutter build apk --release --verbose
          flutter build appbundle --release --verbose

          mkdir -p ../../../dist/android/flutter
          cp -f build/app/outputs/flutter-apk/app-release.apk ../../../dist/android/flutter/
          cp -f build/app/outputs/bundle/release/app-release.aab ../../../dist/android/flutter/

      - name: Checksums
        run: |
          set -euxo pipefail
          cd dist/android/flutter
          sha256sum app-release.apk app-release.aab > SHA256SUMS.txt

      - name: Upload artifact (android)
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            dist/android/flutter/app-release.apk
            dist/android/flutter/app-release.aab
            dist/android/flutter/SHA256SUMS.txt

  linux:
    name: Linux Desktop (Flutter bundle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux deps for Flutter desktop
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev libblkid-dev liblzma-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v || true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Linux desktop bundle
        run: |
          set -euxo pipefail
          ./apps/furry_flutter/create_flutter_app.sh --no-android
          cargo --version
          rustc --version
          cargo build --release -p furry_ffi -v
          cd apps/furry_flutter/furry_flutter_app
          flutter config --enable-linux-desktop
          flutter analyze
          flutter build linux --release --verbose
          cp -f ../../../target/release/libfurry_ffi.so build/linux/x64/release/bundle/
          test -f build/linux/x64/release/bundle/libfurry_ffi.so

          mkdir -p ../../../dist/desktop/flutter/linux
          tar -C build/linux/x64/release -czf ../../../dist/desktop/flutter/linux/furry_flutter_linux.tar.gz bundle

      - name: Checksums
        run: |
          set -euxo pipefail
          cd dist/desktop/flutter/linux
          sha256sum furry_flutter_linux.tar.gz > SHA256SUMS.txt

      - name: Upload artifact (linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: |
            dist/desktop/flutter/linux/furry_flutter_linux.tar.gz
            dist/desktop/flutter/linux/SHA256SUMS.txt

  windows:
    name: Windows Desktop (Flutter bundle)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter doctor
        shell: pwsh
        run: |
          flutter doctor -v

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create Flutter app (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $root = (Get-Location).Path
          $outDir = Join-Path $root "apps\furry_flutter\furry_flutter_app"
          $templates = Join-Path $root "apps\furry_flutter\templates"

          if (!(Test-Path $outDir)) {
            New-Item -ItemType Directory -Force -Path (Split-Path $outDir) | Out-Null
            Push-Location (Split-Path $outDir)
            flutter create --org com.furry --project-name furry_flutter_app --android-language kotlin furry_flutter_app
            Pop-Location
          }

          Push-Location $outDir
          flutter pub add file_picker path_provider just_audio path ffi just_audio_background audio_service smtc_windows dbus
          Pop-Location

          Copy-Item -Recurse -Force (Join-Path $templates "lib\*") (Join-Path $outDir "lib")
          Copy-Item -Recurse -Force (Join-Path $templates "android\*") (Join-Path $outDir "android")
          if (Test-Path (Join-Path $templates "test")) {
            Copy-Item -Recurse -Force (Join-Path $templates "test\*") (Join-Path $outDir "test")
          }
          if (Test-Path (Join-Path $templates "analysis_options.yaml")) {
            Copy-Item -Force (Join-Path $templates "analysis_options.yaml") (Join-Path $outDir "analysis_options.yaml")
          }

      - name: Build Windows desktop bundle
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $env:RUST_BACKTRACE = "1"
          $root = (Get-Location).Path
          cargo --version
          rustc --version
          cargo build --release -p furry_ffi -v
          cd apps/furry_flutter/furry_flutter_app
          flutter config --enable-windows-desktop
          flutter analyze
          flutter build windows --release --verbose

          New-Item -ItemType Directory -Force -Path ..\..\..\dist\desktop\flutter\windows | Out-Null
          $dllSrc = Join-Path $root "target\\release\\furry_ffi.dll"
          if (!(Test-Path $dllSrc)) { throw "Missing furry_ffi.dll at: $dllSrc" }
          Copy-Item -Force $dllSrc build\windows\x64\runner\Release\
          if (!(Test-Path "build\\windows\\x64\\runner\\Release\\furry_ffi.dll")) { throw "Failed to copy furry_ffi.dll into Release folder" }
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath ..\..\..\dist\desktop\flutter\windows\furry_flutter_windows.zip -Force
          if (!(Test-Path "..\\..\\..\\dist\\desktop\\flutter\\windows\\furry_flutter_windows.zip")) { throw "Failed to create zip bundle" }

      - name: Checksums
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd dist\desktop\flutter\windows
          $hash = (Get-FileHash furry_flutter_windows.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  furry_flutter_windows.zip" | Out-File -Encoding ascii SHA256SUMS.txt

      - name: Upload artifact (windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: |
            dist/desktop/flutter/windows/furry_flutter_windows.zip
            dist/desktop/flutter/windows/SHA256SUMS.txt

  publish:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [android, linux, windows]
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare assets
        run: |
          set -euxo pipefail
          mkdir -p release-assets
          # Keep per-artifact subfolders to avoid filename collisions (e.g. multiple SHA256SUMS.txt).
          cp -a artifacts/. release-assets/
          find release-assets -type f -maxdepth 4 -print

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*
          generate_release_notes: true
